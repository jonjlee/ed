<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
	
    <title>ED Algorithms</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <!-- Alpaca forms -->
    <link type="text/css" href="https://code.cloudcms.com/alpaca/1.5.17/bootstrap/alpaca.min.css" rel="stylesheet" />
    <style type="text/css" media="screen">
        #code { 
          height: 180px;
        }
    </style>
  </head>
  <body>

    <div class="container-fluid">
      <div class="row">
        <div class="col-md-12">
          <h2 id="title"></h2>
        </div>
      </div>
      <div class="row">
        <div id="form-container" class="col-md-6">
          <div id="form"></div>
        </div>
        <div class="col-md-6">
          <h4>Results and Next Steps</h4>
          <div id="result"><small class="text-muted">Answers questions on the left for recommended next steps.</small></div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <hr/>
          <h4>Update Algorithm Definition:</h4>
          <div id="code"></div>
          <div>&nbsp;</div>
          <button id="update" class="btn btn-primary">Update</button>
        </div>
      </div>
      <div class="row">&nbsp;</div>
    </div>

    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://code.cloudcms.com/alpaca/1.5.17/bootstrap/alpaca.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/lodash/4.13.1/lodash.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/ace/1.2.4/min/ace.js"></script>
    <script id="source" type="text/javascript">
      var algorithm = {
        title: 'Intussusception',
        questions: [
          {
            id: 'risk', 
            q: ['Patient risk:', ['Low', 'High']],
            note: 'Low risk if poorly differentiated abd pain or non-episodic. Moderate/high risk if palpable mass, episodic fussiness/pain, bloody stool, lethargy.'
          },{
            id: 'cecum',
            q: ['Cecum visualized on AP & decub x-ray?', ['Yes', 'No']],
          },{
            id: 'us',
            q: ['Ultrasound positive for intussusception?', ['Yes', 'No']],
          }
        ],
        responses: [
          {default: true, response: 'More information needed. Refer to the <a href="http://child.childrens.sea.kids/Documents/Clinical_Standard_Work_Pathways_and_Tools/Pneumonia/Pneumonia_Pathway.aspx">Pneumonia Pathway</a>.'},
          {us: 'Yes', response: 'Confirmed intussusception:<ol><li>Consult gen surg</li><li>ED provider order cefoxitin and abdominal 2 view X-ray prior to contrast enema</li><li>Air/contrast enema</li></ol>'},
          {us: 'No', response: 'Intussusception ruled out. Continue medical assessment.'},
          {risk: 'Low', cecum: '', response: 'Low risk patients start with AP & decub 2-view X-ray. Keep NPO.'},
          {risk: 'Low', cecum: 'Yes', response: 'Continue medical assessment. Can consider labs and U/S if still concern for intussusception.'},
          {risk: 'Low', cecum: 'No', response: 'Non-visualizable cecum makes patient moderate/high risk:<ol><li>NPO and CR monitor</li><li>PIV and labs</li><li>Ultrasound</li><li>If unstable call gen surg</li></ol>'},
          {risk: 'High', response: 'Ultrasound for patients with moderate/high risk:<ol><li>NPO and CR monitor</li><li>PIV and labs</li><li>Ultrasound</li><li>If unstable call gen surg</li></ol>'},
        ]
      }
    </script>
    <script>
      // Common UI elements
      var $title = $('#title'),
          $form = $('#form'),
          $result = $('#result'),
          alpacaForm = null;
          editor = null;

      function algToAlpaca(alg) {
        // Convert our custom question definition format to alpaca schema
        var questionNum = 1;
        var properties = _.reduce(alg.questions, function(p, question) {
          p[question.id] = {
            type: 'string',
            title: questionNum++ + '. ' + question.q[0],
            enum: question.q[1],
          }
          return p;
        }, {});
        var field_options = _.reduce(alg.questions, function(p, question) {
          p[question.id] = {
            hideNone: true,
            sort: false,
            helper: question.note
          }
          return p;
        }, {});
        var defaultResponse = _.find(alg.responses, 'default') || {response: 'Unable to calculate result.'}
        var processFun = alg.process || function(vals) {
          var found = _.find(alg.responses, function(response) {
            // Find the first response where vals meets all the conditions specified.
            // Values set in the form but not required in the response are ignored.
            // e.g. {risk: 'High', xr: 'Yes'} matches the response {xr: 'Yes', response: 'X-ray done.'}.
            return _.every(response, function(responseVal, key) {
              responseVal = (responseVal == '') ? undefined : responseVal;
              return key == 'response' || vals[key] == responseVal;
            });
          });
          return found && found.response || defaultResponse.response;
        };
      
        return {
          schema: {
            type: 'object',
            properties: properties
          },
          options: {
            fields: field_options,
          },
          postRender: function(control) {
            alpacaForm = control;
            alpacaForm.process = processFun;
            _.each(alpacaForm.children, function(f) {
              f.on('change', update);
            });
          }
        };
      }
      
      function update() {
        var vals = alpacaForm.getValue(),
            result = alpacaForm.process(vals);
        $result.html(result);
      };
      
      function initAlgorithm(algorithm) {
        var schema = algToAlpaca(algorithm);
        $title.html(algorithm.title);
        $form.alpaca(schema);
      }
      
      function initAceEditor() {
        editor = ace.edit("code");
        editor.commands.addCommand({
            name: 'update',
            bindKey: 'Ctrl-Enter',
            exec: function() { $('#update').click(); }
        });
        editor.getSession().setMode("ace/mode/javascript");
        editor.getSession().setTabSize(2);
        editor.getSession().setUseSoftTabs(true);
        editor.setValue($('#source').html(), -1);
      }
      
      function initHandlers() {
        $('#update').click(function() {
          eval(editor.getValue());
          alpacaForm.destroy();
          $result.html('<small class="text-muted">Answers questions on the left for recommended next steps.</small>');
          initAlgorithm(algorithm);
        });

        // Allow check boxes to be unselected on click
        $('#form-container').on('click', 'input:radio', function(e){
          var $r = $(this),
              $group = $('input[name|="'+ $r.prop("name") + '"]');
          if($r.hasClass('uncheck')){
              $group.removeClass('uncheck');
              $r.prop('checked', false);
              update();
          } else if($r.is(':checked')) {
              $group.removeClass('uncheck');
              $r.addClass('uncheck');
          }
        });
      }
      
      function initUI() {
        initAlgorithm(algorithm);
        initAceEditor();
        initHandlers();
      }
      
      $(function() {
        initUI();
      });
    </script>
  </body>
</html>
